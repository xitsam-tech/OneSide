
<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Krypto Marktübersicht – Onefile</title>
<style>
:root{
  --header-extra:14px;
  --bg:#0c0f14; --panel:#111826; --card:#0f1521; --border:#1e293b; --text:#e8edf4; --muted:#98a2b3;
  --accent:#60a5fa; --green:#22c55e; --red:#ef4444; --amber:#f59e0b;
  --gap:12px; --spark-h:42px; --spark-compact-h:32px;
  --header-h:72px;
}
:root[data-theme="light"]{
  --bg:#f5f7fb; --panel:#ffffff; --card:#ffffff; --border:#e5e7eb; --text:#0f172a; --muted:#64748b;
  --accent:#2563eb; --green:#16a34a; --red:#dc2626; --amber:#b45309;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif}
a{color:var(--accent);text-decoration:none}a:hover{text-decoration:underline}
.wrap{max-width:1400px;margin:0 auto;padding:16px}
main{padding-top:calc(var(--header-h) + var(--header-extra));}

.topbar{position:fixed;top:0;left:0;right:0;background:var(--panel);
  border-bottom:1px solid var(--border);z-index:9999;box-shadow:0 8px 20px rgba(0,0,0,.32)}
:root[data-theme="light"] .topbar{box-shadow:0 8px 20px rgba(0,0,0,.12)}
.head-row{display:flex;justify-content:space-between;gap:12px;align-items:center;flex-wrap:wrap}
.title{font-weight:700}
.meta{color:var(--muted);font-size:.92rem}
.toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.btn{display:inline-flex;gap:8px;align-items:center;background:var(--panel);border:1px solid var(--border);
  color:var(--text);padding:8px 12px;border-radius:10px;cursor:pointer}
.pill{display:inline-flex;align-items:center;gap:8px;background:var(--card);border:1px solid var(--border);
  padding:6px 10px;border-radius:999px}
.badge{display:inline-block;border:1px solid var(--border);padding:2px 8px;border-radius:999px;font-size:.75rem;color:var(--muted);background:var(--card)}

.section{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:12px;margin-top:16px}
.section h2{margin:0 0 8px 0;font-size:1rem}
.hint{color:var(--muted);font-size:.9rem}
.small{font-size:.82rem}
.ok{color:var(--green)} .error{color:var(--red)}

.kacheln{display:grid;gap:var(--gap)}
@media(min-width:1200px){ .kacheln{grid-template-columns:repeat(5, minmax(0,1fr));} }
@media(max-width:1199.98px){ .kacheln{grid-template-columns:repeat(auto-fit,minmax(290px,1fr));} }

.coin{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px;display:flex;flex-direction:column;gap:8px}
.coin header{display:flex;justify-content:space-between;align-items:center;gap:8px}
.hdr-right{display:flex;gap:6px;align-items:center;white-space:nowrap;max-width:60%;overflow:hidden;text-overflow:ellipsis}
.sym{font-weight:700}
.muted{color:var(--muted)}
.row{display:flex;justify-content:space-between;gap:8px;align-items:center}
canvas.spark{width:100%;height:var(--spark-h);background:linear-gradient(180deg,#0b111a,#0b111a);border-radius:6px}
:root[data-theme="light"] canvas.spark{background:linear-gradient(180deg,#eef2f7,#eef2f7)}
canvas.spark.compact{height:var(--spark-compact-h)}
.coin.compact{padding:8px}
.badge-buzz{border:1px solid var(--accent);background:rgba(96,165,250,.12);color:var(--accent);padding:2px 6px;border-radius:999px;font-size:.72rem}

.table-wrap{overflow-x:auto}
.table{width:100%;border-collapse:collapse;table-layout:fixed}
.table th,.table td{padding:8px;border-bottom:1px solid var(--border);text-align:left;white-space:nowrap}
.table th{color:var(--muted)}
.table td.col-reason{white-space:normal}
.col-bear{color:var(--red);font-weight:600}
.col-base{color:var(--amber);font-weight:600}
.col-bull{color:var(--green);font-weight:600}
.emph{border-radius:6px;padding:2px 6px;box-shadow:inset 0 0 0 1px rgba(255,255,255,.08)}

.disclaimer{margin-top:6px;padding:8px;border:1px dashed var(--amber);border-radius:8px;color:var(--amber);background:rgba(245,158,11,.08);font-size:.88rem}

details.geo{background:var(--card);border:1px solid var(--border);border-radius:10px;padding:8px}
details.geo summary{cursor:pointer}

.modal-backdrop{position:fixed;inset:0;display:none;align-items:flex-start;justify-content:center;background:rgba(0,0,0,.55);z-index:10000}
.modal-backdrop[open]{display:flex}
.modal{background:var(--panel);border:1px solid var(--border);border-radius:18px;width:min(840px,92vw);max-height:92vh;overflow:auto;padding:16px;margin-top:6vh}
.modal header{display:flex;justify-content:space-between;align-items:center}
fieldset{border:1px solid var(--border);border-radius:12px;background:var(--card);padding:12px}
legend{padding:0 8px;color:var(--muted);font-size:.85rem}
.form-grid{display:grid;gap:14px}
@media(min-width:768px){ .form-grid{grid-template-columns:1fr 1fr} }
.seg{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px}
.seg input{display:none}
.seg label{border:1px solid var(--border);border-radius:999px;padding:6px 10px;cursor:pointer}
.seg input:checked + label{background:var(--accent);border-color:var(--accent);color:#fff}
.switch{display:inline-flex;align-items:center;gap:8px}
.switch input{appearance:none;width:42px;height:24px;border-radius:999px;background:var(--border);position:relative;cursor:pointer}
.switch input::after{content:"";position:absolute;top:3px;left:3px;width:18px;height:18px;border-radius:50%;background:#fff;transition:left .2s}
.switch input:checked{background:var(--accent)}
.switch input:checked::after{left:21px}
.modal .actions{position:sticky;bottom:0;background:linear-gradient(180deg,transparent,var(--panel));padding-top:10px;display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

/* Legal footer */
.legal-foot{background:var(--panel);border-top:1px solid var(--border);margin-top:16px}
.legal-foot .wrap{padding-block:16px}
.legal-foot .row{display:flex;flex-direction:column;gap:6px}
.legal-foot .small{font-size:.82rem;color:var(--muted)}
.legal-foot a{color:var(--accent);text-decoration:none}
.legal-foot a:hover{text-decoration:underline}

/* legacy body pad */
body[data-pad='on']{padding-top:calc(var(--header-h) + var(--header-extra));}

/* === Toggle feedback (visible ON/OFF) === */
:root{--chip-on-bg:#16a34a;--chip-on-fg:#03140a;--chip-off-bg:#334155;--chip-off-fg:#cbd5e1;--switch-on:#2563eb;--switch-off:#1f2937}
.switch{display:inline-flex;align-items:center;gap:6px;cursor:pointer}
.switch input{width:46px;height:26px;appearance:none;border-radius:999px;background:var(--switch-off);position:relative;outline:0;border:1px solid #0f172a}
.switch input::after{content:'';position:absolute;top:3px;left:3px;width:20px;height:20px;background:#fff;border-radius:50%;transition:left .18s ease}
.switch input:checked{background:var(--switch-on)}
.switch input:checked::after{left:23px}
.switch input + span::after{content:'AUS';display:inline-block;margin-left:6px;padding:2px 8px;border-radius:999px;background:var(--chip-off-bg);color:var(--chip-off-fg);font-size:.72rem}
.switch input:checked + span::after{content:'AN';background:var(--chip-on-bg);color:var(--chip-on-fg)}


/* Positive/Negative coloring */
.pos{ color: var(--green); font-weight:600 }
.neg{ color: var(--red);   font-weight:600 }

/* Mobile overlay for coin details */
.overlay{ position:fixed; inset:0; background:rgba(2,6,23,.65); display:none; z-index:9999 }
.overlay.open{ display:grid; place-items:center }
.overlay-card{ background:var(--panel); border:1px solid var(--border); border-radius:14px; width:min(640px,92vw); max-height:90vh; overflow:auto; padding:16px; box-shadow:0 10px 30px rgba(0,0,0,.45) }
.overlay-card .close{ float:right; font-size:20px; line-height:20px; padding:4px 10px; border-radius:10px }


/* Mobile compact cards */
@media (max-width: 640px){
  .coin{ cursor:pointer }
  .coin header .muted.small{ display:none } /* hide long name */
  .coin .spark{ display:none !important }
  .coin .row{ display:none }
  .coin .row.price{ display:flex } /* only price visible */
}


/* inline price in header */
.coin header{ align-items:center; }
.price-inline{ font-weight:700; margin-left:auto; }


/* === Crypto‑Pulse tiles === */
.pulse-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px}
.pulse-grid .tile{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:10px}
.pulse-grid .klabel{font-size:12px;color:var(--muted)}
.pulse-grid .kval{font-size:22px;font-weight:700;margin-top:2px}
.pulse-grid .ksub{font-size:12px;color:var(--muted);margin-top:2px}
.pulse-grid .red .kval{color:#ef4444}
.pulse-grid .green .kval{color:#22c55e}
.pulse-grid .yellow .kval{color:#eab308}

/* compact bullets for KI-Themen */
ul.bullets{ list-style:none; padding-left:0; margin:6px 0 }
ul.bullets li{ font-size:.9rem; line-height:1.35; margin:2px 0 }
#geoTopicsList li{ font-size:.9rem; }
#geoToolbar{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin:.25rem 0 .5rem 0 }
#geoToolbar .muted{ font-size:.8rem }
#geoSrcList{ font-size:.8rem; color:var(--muted); margin-top:4px }

</style>
</head>
<body>
<header class="topbar">
  <div class="wrap head-row">
    <div>
      <div class="title">Krypto Marktübersicht (Top‑<span id="hdrCount">5</span> · ohne Stablecoins)</div>
      <div class="meta" id="meta-time">Lade …</div>
    </div>
    <div class="toolbar">
      <label class="pill"><input type="checkbox" id="autoReloadToggle"> <span id="autoLbl">Auto 15 min</span> <span id="autoCountdown" class="badge">–:–</span></label>
      <button class="btn" id="refreshBtn">↻ Neu laden</button>
      <button class="btn" id="openSettingsBtn">⚙️ Einstellungen</button>
    </div>
  </div>
</header>

<main class="wrap">
  <div id="marketsBanner"></div>
  <div class="hint small" id="globalStatus" aria-live="polite">Initialisiere…</div>

  <section class="section">
    <h2><span id="topNLabel">Top‑5 Coins</span> <span class="badge" id="ts-top">–</span></h2>
    <div id="coinGrid" class="kacheln"></div>
    <div id="topNote" class="hint small"></div>
  </section>
  <section id="crypto-pulse" class="card" style="margin-top:12px">
    <header class="row between center">
      <div class="title">Krypto‑Pulse (kompakt)</div>
      <div class="small muted" id="pulseStatus">lädt…</div>
    </header>
    <div id="pulseGrid" class="grid pulse-grid">
      <div class="tile" id="pulse-btcdom"><div class="klabel">BTC‑Dominanz</div><div class="kval">–</div><div class="ksub"></div></div>
      <div class="tile" id="pulse-ethbtc"><div class="klabel">ETH/BTC</div><div class="kval">–</div><div class="ksub"></div></div>
      <div class="tile" id="pulse-stables"><div class="klabel">Stable‑Power</div><div class="kval">–</div><div class="ksub"></div></div>
      <div class="tile" id="pulse-funding"><div class="klabel">Funding BTC/ETH</div><div class="kval">–</div><div class="ksub"></div></div>
      <div class="tile" id="pulse-breadth"><div class="klabel">Breadth 7d</div><div class="kval">–</div><div class="ksub"></div></div>
      <div class="tile" id="pulse-mempool"><div class="klabel">BTC Fees</div><div class="kval">–</div><div class="ksub"></div></div>
    </div>
  </section>


  <!-- Fear & Greed -->
  <section class="section" aria-labelledby="h-fgi">
    <h2 id="h-fgi">Fear & Greed Index <span class="badge" id="ts-fgi">–</span></h2>
    <div id="fgiBox" class="grid cols-2" style="align-items:center">
      <div>
        <div id="fgiGauge" class="title" aria-live="polite">Lade FGI…</div>
        <div class="hint small" id="fgiText"></div>
      </div>
      <div id="fgiImgWrap" style="display:none">
        <img src="https://alternative.me/crypto/fear-and-greed-index.png" alt="FGI Bild Fallback" style="max-width:100%;border:1px solid var(--border);border-radius:8px"/>
      </div>
    </div>
  </section>

<!-- Geopolitik & Makro -->
 <section class="section" aria-labelledby="h-geo">
  <h2 id="h-geo">
    Geopolitik &amp; Makro (kompakt)
    <span class="badge" id="geoFeedStatus">–</span>
  </h2>

  <div class="toolbar" style="gap:8px;margin-bottom:6px">
    <button class="btn" id="geoReload">↻ Neu laden</button>
    <label class="pill">Sprache&nbsp;
      <select id="geoLang" style="background:var(--card);color:var(--text);border:0">
        <option value="EN" selected>EN</option>
        <option value="DE">DE</option>
      </select>
    </label>
    <span class="hint small">Quellen werden live aus dem KI-Feed bezogen.</span>
  </div>

  <ul class="bullets" id="geoTopicsList" aria-live="polite"></ul>
  <div id="geoError" class="small error" style="display:none"></div>
</section>


  <!-- Szenarien -->
  <section class="section" aria-labelledby="h-scen">
    <h2 id="h-scen">Szenario-Modul (Bull/Base/Bear) <span class="badge" id="ts-scen">–</span></h2>
    <div class="hint small">Automatisch aus Trend/Momentum/Volumen abgeleitet. Farblegende: <span class="neg">Down = rot</span> · <span class="muted" style="color:var(--amber)">Middle = orange</span> · <span class="pos">Up = grün</span>. Keine Anlageberatung.</div>
    <div class="table-wrap">
      <table class="table scen" id="scenTable" aria-label="Szenario Tabelle">
        <colgroup>
          <col style="width:96px" />
          <col style="width:72px" />
          <col style="width:72px" />
          <col style="width:72px" />
          <col class="reason" />
        </colgroup>
        <thead>
          <tr>
            <th>Coin</th>
            <th>Bull</th>
            <th>Base</th>
            <th>Bear</th>
            <th class="col-reason">Begründung (kurz)</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="disclaimer" role="note">
      Hinweis & Haftungsausschluss: Dies ist <strong>keine Anlageberatung</strong>. Wahrscheinlichkeiten sind grobe Bandbreiten (z. B. 25/50/25) auf Basis öffentlicher Marktdaten (7-Tage-Sparkline, 24h/7d-Änderung, Volumen). Eigene Recherche bleibt unerlässlich.
    </div>
  </section>

  <section class="section" id="exchangesSection">
    <h2>Börsen (Accounts & Verbindungen)</h2>
    <div id="exchList" class="kacheln" style="grid-template-columns:repeat(2,minmax(0,1fr))"></div>
    <div class="hint small">Ref‑Links lokal gespeichert. API‑Verbindungen folgen später.</div>
  </section>
</main>

<!-- Einstellungen -->
<div class="modal-backdrop" id="settingsModal" aria-hidden="true">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
    <header><h3 id="settingsTitle">Einstellungen</h3><button class="btn" id="closeSettingsBtn">✕</button></header>
    <form id="settingsForm">
      <div class="form-grid">
        <fieldset>
          <legend>Allgemein</legend>
          <div class="small">Währung</div>
          <div class="seg">
            <input type="radio" id="ccy_eur" name="ccy" value="EUR"><label for="ccy_eur">EUR</label>
            <input type="radio" id="ccy_usd" name="ccy" value="USD"><label for="ccy_usd">USD</label>
            <input type="radio" id="ccy_gbp" name="ccy" value="GBP"><label for="ccy_gbp">GBP</label>
            <input type="radio" id="ccy_jpy" name="ccy" value="JPY"><label for="ccy_jpy">JPY</label>
          </div>
          <div class="small" style="margin-top:8px">Anzahl Coins</div>
          <div class="seg">
            <input type="radio" id="cnt_5" name="count" value="5"><label for="cnt_5">Top‑5</label>
            <input type="radio" id="cnt_10" name="count" value="10"><label for="cnt_10">Top‑10</label>
            <input type="radio" id="cnt_50" name="count" value="50"><label for="cnt_50">Top‑50</label>
            <input type="radio" id="cnt_100" name="count" value="100"><label for="cnt_100">Top‑100</label>
          </div>
          <div class="small" style="margin-top:8px">Chart‑Zeitraum</div>
          <div class="seg">
            <input type="radio" id="rg_7" name="range" value="7"><label for="rg_7">7 Tage</label>
            <input type="radio" id="rg_30" name="range" value="30"><label for="rg_30">30 Tage</label>
          </div>
        </fieldset>

        <fieldset>
          <legend>Darstellung</legend>
          <div class="small">Theme</div>
          <div class="seg">
            <input type="radio" id="th_dark" name="theme" value="dark"><label for="th_dark">Dunkel</label>
            <input type="radio" id="th_light" name="theme" value="light"><label for="th_light">Hell</label>
          </div>
          <label class="switch" style="margin-top:8px"><input type="checkbox" id="trendBgToggle"><span>Trend‑Farbe (Karten)</span></label>
          <label class="switch" style="margin-top:8px"><input type="checkbox" id="dyorToggle"><span>DYOR‑Zeile</span></label>
          <label class="switch" style="margin-top:8px"><input type="checkbox" id="buzzToggle"><span>Buzz‑Badge</span></label>
          <label class="switch" style="margin-top:8px"><input type="checkbox" id="showExchToggle"><span>Börsen‑Block anzeigen</span></label>
        </fieldset>

        <fieldset>
          <legend>Auto‑Reload</legend>
          <label class="switch"><input type="checkbox" id="autoReloadToggleSettings"><span>Auto aktiv</span></label>
          <div class="small" style="margin-top:8px">Intervall</div>
          <div class="seg">
            <input type="radio" id="ar_5" name="ar" value="5"><label for="ar_5">5 min</label>
            <input type="radio" id="ar_15" name="ar" value="15"><label for="ar_15">15 min</label>
            <input type="radio" id="ar_30" name="ar" value="30"><label for="ar_30">30 min</label>
          </div>
        </fieldset>
      </div>
      <div class="actions">
        <button type="button" class="btn" id="cancelSettingsBtn">Abbrechen</button>
        <button type="submit" class="btn">✔ Speichern</button>
      </div>
    </form>
  </div>
</div>
<footer>
<div class="legal-foot">
  <div class="wrap">
    <div class="small">
      Quellen (nur Referenzen):
      <a href="https://www.coingecko.com/en/api" target="_blank" rel="noopener">CoinGecko API</a> ·
      <a href="https://www.coinlore.com/cryptocurrency-data-api" target="_blank" rel="noopener">CoinLore API</a> ·
      <a href="https://exchangerate.host/" target="_blank" rel="noopener">exchangerate.host (FX)</a> ·
      <a href="https://alternative.me/crypto/fear-and-greed-index/" target="_blank" rel="noopener">Fear &amp; Greed</a> ·
      <a href="https://api.binance.com/api/v3/ticker/24hr" target="_blank" rel="noopener">Binance 24h Ticker</a> ·
      <a href="https://binance-docs.github.io/apidocs/futures/en/#funding-rate-history" target="_blank" rel="noopener">Binance Futures Funding</a> ·
      <a href="https://mempool.space/docs/api" target="_blank" rel="noopener">mempool.space API</a>
    </div>
  </div>
</div>
</footer>

<script>
// ========= Utilities / State =========
const TZ='Europe/Vienna';
const STABLE_IDS=new Set(['tether','usd-coin','binance-usd','dai','true-usd','frax','pax-dollar','usdd','first-digital-usd','fdusd','lusd','usde','gusd','usdp','paypal-usd']);
function q(s,el){return (el||document).querySelector(s)}; function qa(s,el){return Array.from((el||document).querySelectorAll(s));}
function nowV(){ return new Date(new Date().toLocaleString('en-US',{timeZone:TZ})) }

let CURRENCY=(localStorage.getItem('ccy')||'EUR').toUpperCase();
let COUNT=parseInt(localStorage.getItem('count')||'5',10);
let RANGE=parseInt(localStorage.getItem('range')||'7',10);
let THEME=localStorage.getItem('theme')||'dark';
let TREND_BG=(localStorage.getItem('trendBg')||'off')==='on';
let SHOW_DYOR=(localStorage.getItem('showDyor')||'on')==='on';
let SHOW_BUZZ=(localStorage.getItem('showBuzz')||'on')==='on';
let SHOW_EXCH=(localStorage.getItem('showExch')||'on')==='on';
let AUTO_RELOAD=(localStorage.getItem('autoReload')||'off')==='on';
let AUTO_MIN=parseInt(localStorage.getItem('autoMin')||'15',10);

let lastCoins=[]; let trendingIds=new Set();
let autoTimer=null; let nextReloadAt=null; let countdownTimer=null;

function applyTheme(){ document.documentElement.setAttribute('data-theme',THEME); }
function applyTrendBg(){ document.body.classList.toggle('trend-on',!!TREND_BG); }
function applyShowExch(){ const sec=document.getElementById('exchangesSection'); if(sec){ sec.style.display = SHOW_EXCH ? '' : 'none'; } }
function updateAutoLabel(){ const el=q('#autoLbl'); if(el) el.textContent='Auto '+AUTO_MIN+' min'; }
function updateCountdown(){
  const el=q('#autoCountdown'); if(!el) return;
  if(AUTO_RELOAD && nextReloadAt){ const diff=Math.max(0,nextReloadAt-Date.now()); const mm=Math.floor(diff/60000), ss=Math.floor((diff%60000)/1000); el.textContent=String(mm).padStart(2,'0')+':'+String(ss).padStart(2,'0'); }
  else el.textContent='–:–';
}
function layoutPad(){ const h=q('.topbar'); const hp=(h&&h.getBoundingClientRect)?Math.ceil(h.getBoundingClientRect().height):72; document.documentElement.style.setProperty('--header-h',hp+'px'); document.body.setAttribute('data-pad','on'); }

function fmtCur(n){ return new Intl.NumberFormat('de-AT',{style:'currency',currency:CURRENCY,maximumFractionDigits:2}).format(n); }
function fmtCurC(n){ return new Intl.NumberFormat('de-AT',{style:'currency',currency:CURRENCY,notation:'compact',maximumFractionDigits:2}).format(n); }
function fmtPct(n){ if(n==null||isNaN(n)) return '–'; return new Intl.NumberFormat('de-AT',{maximumFractionDigits:2,minimumFractionDigits:2}).format(n)+'%'; }
function pc(v){ return (v==null)?'':(v>=0?'pos':'neg'); }

function stamp(msg, ok=true){ const t=nowV().toLocaleString('de-AT',{timeZone:TZ,hour12:false}); q('#globalStatus').textContent = (ok?'Fertig. ':'Hinweis: ') + msg; return t; }

// ========= Auto reload =========
function setAutoReload(enabled){
  const t1=q('#autoReloadToggle'), t2=q('#autoReloadToggleSettings');
  if(t1) t1.checked=!!enabled; if(t2) t2.checked=!!enabled;
  localStorage.setItem('autoReload', enabled?'on':'off');
  AUTO_RELOAD=!!enabled; updateAutoLabel();
  if(autoTimer){ clearInterval(autoTimer); autoTimer=null; }
  if(!countdownTimer){ countdownTimer=setInterval(updateCountdown,1000); }
  if(AUTO_RELOAD){ nextReloadAt=Date.now()+AUTO_MIN*60*1000; updateCountdown(); autoTimer=setInterval(()=>{ boot(); }, AUTO_MIN*60*1000); }
  else { nextReloadAt=null; updateCountdown(); }
}



// ---- Geo/Macro language preference + sources ----
let GEO_LANG = (localStorage.getItem('geoLang') || 'en'); // English preferred by default
function applyGeoLangUI(){
  const sel = q('#geoLangSel'); if(sel){ sel.value = GEO_LANG; sel.addEventListener('change',()=>{
    GEO_LANG = sel.value; localStorage.setItem('geoLang', GEO_LANG);
    updateGeoTopics(true);
  });}
}
function normalizeBulletsForLang(bullets, lang){
  // Keep as-is; server should honor language. As fallback, we just return given bullets.
  return bullets || [];
}
function renderGeoSources(items){
  try{
    const box = q('#geoSrcList'); if(!box) return;
    const domains = Array.from(new Set(items.map(it => (it.domain || new URL(it.url).hostname).replace(/^www\./,''))));
    const max = Math.min(6, domains.length);
    const parts = domains.slice(0,max).map(d => `<a href="https://${d}" target="_blank" rel="noopener">${d}</a>`);
    box.innerHTML = parts.length ? `Quellen: ${parts.join(' · ')}` : '';
  }catch(_){}
}

// === KI‑gestützte Geo/Makro‑Themen (4h, kompakt) ===
async function fetchGeoFeed(){ try{
  const r = await fetch('/api/geo_feed', {cache:'no-store'});
  if(!r.ok) throw new Error('HTTP '+r.status);
  return await r.json();
}catch(e){ console.warn('geo_feed error:', e); return {items:[], error:String(e)}; }}

function renderGeoTopicsCompact(items, bullets){
  const list = q('#geoTopicsList'); if(!list) return;
  list.innerHTML = '';
  const n = Math.min(4, items.length, (bullets&&bullets.length)||0);
  for(let i=0;i<n;i++){
    const it = items[i]; const b = (bullets[i]||'').replace(/^[-•\s]+/, '').trim();
    const li = document.createElement('li');
    const idx = i+1;
    const a = document.createElement('a'); a.href = it.url; a.target='_blank'; a.rel='noopener';
    const domain = it.domain || (new URL(it.url)).hostname.replace(/^www\./,'');
    a.textContent = `${domain} – ${ (it.title||'').trim().slice(0,120) }`;
    li.textContent = `• ${b} (`;
    li.appendChild(a);
    li.appendChild(document.createTextNode(')'));
    list.appendChild(li);
  }
}



// ========= Data =========

// === Crypto‑Pulse (kompakt) ===
const STABLE_SYMS = new Set(['USDT','USDC','FDUSD','TUSD','DAI','USDP','USDD','PYUSD','GUSD','EURS','EURT']);
const STABLE_ID_PARTS = ['tether','usd-coin','binance-usd','dai','true-usd','pax','usdd','pyusd','gusd','euro-','eur-','fdusd'];
function isStableCoin(row){
  try{
    const sym = String(row.symbol||'').toUpperCase();
    const id  = String(row.id||'').toLowerCase();
    const name= String(row.name||'').toLowerCase();
    if(STABLE_SYMS.has(sym)) return true;
    return STABLE_ID_PARTS.some(p=> id.includes(p) || name.includes(p));
  }catch(_){ return false; }
}
function fmtPct(v){ if(v==null||!isFinite(v)) return '–'; const s=(v>=0?'+':'')+v.toFixed(1)+'%'; return s; }
function setPulseTile(id, {val, sub, state}){
  const el = document.getElementById(id); if(!el) return;
  el.classList.remove('red','green','yellow');
  if(state) el.classList.add(state);
  const kval = el.querySelector('.kval'), ksub = el.querySelector('.ksub');
  if(kval) kval.textContent = val!=null? String(val) : '–';
  if(ksub) ksub.textContent = sub||'';
}
async function fetchFunding(){
  try{
    const [b,e] = await Promise.all([
      fetchWithTimeout('https://fapi.binance.com/fapi/v1/premiumIndex?symbol=BTCUSDT',{timeoutMs:7000}).then(r=>r.json()),
      fetchWithTimeout('https://fapi.binance.com/fapi/v1/premiumIndex?symbol=ETHUSDT',{timeoutMs:7000}).then(r=>r.json())
    ]);
    const fB = (parseFloat(b.lastFundingRate||b.fundingRate)||0)*100;
    const fE = (parseFloat(e.lastFundingRate||e.fundingRate)||0)*100;
    return {btc:fB, eth:fE, next:new Date(+b.nextFundingTime||+e.nextFundingTime||Date.now())};
  }catch(_){ return {btc:null,eth:null,next:null}; }
}
async function fetchFees(){
  try{
    const j = await fetchWithTimeout('https://mempool.space/api/v1/fees/recommended',{timeoutMs:7000}).then(r=>r.json());
    const hi = j.fastestFee??j.high_priority??null;
    const lo = j.hourFee??j.economyFee??null;
    return {fast:hi, hour:lo};
  }catch(_){ return {fast:null,hour:null}; }
}
function updateCryptoPulse(srcTag){
  const coins = Array.isArray(lastCoins)? lastCoins : [];
  const exStable = coins.filter(c=> !isStableCoin(c) );
  const withMc = exStable.filter(c=> typeof c.mc==='number' && isFinite(c.mc) && c.mc>0);
  const totalMc = withMc.reduce((a,c)=> a+(c.mc||0), 0);
  const btc = coins.find(c=> (String(c.id||'').toLowerCase()==='bitcoin' || String(c.symbol||'').toUpperCase()==='BTC'));
  const eth = coins.find(c=> (String(c.id||'').toLowerCase()==='ethereum' || String(c.symbol||'').toUpperCase()==='ETH'));
  // 1) BTC Dominance
  let dom = null;
  if(btc && totalMc>0 && typeof btc.mc==='number') dom = (btc.mc/totalMc)*100;
  setPulseTile('pulse-btcdom', {
    val: dom!=null? dom.toFixed(1)+'%' : '–',
    sub: srcTag==='BINANCE' ? 'n.v. (ohne MC)' : (dom!=null? 'ex‑Stable, Top‑N' : 'Daten unvollständig'),
    state: (dom!=null? (dom>=55?'yellow':(dom<=45?'green':null)) : null)
  });
  // 2) ETH/BTC
  const ratio = (btc&&eth && btc.price>0 && eth.price>0) ? (eth.price/btc.price) : null;
  setPulseTile('pulse-ethbtc', {
    val: ratio!=null? ratio.toFixed(3) : '–',
    sub: 'Preis‑Ratio',
    state: ratio!=null? (ratio>=0.06? 'green' : (ratio<0.05? 'red': null)) : null
  });
  // 3) Stable‑Power
  const stables = coins.filter(isStableCoin).filter(c=> typeof c.mc==='number' && c.mc>0);
  const stableMc = stables.reduce((a,c)=> a+(c.mc||0), 0);
  const share = (stableMc>0 && (stableMc+totalMc)>0) ? (stableMc/(stableMc+totalMc))*100 : null;
  setPulseTile('pulse-stables', {
    val: share!=null? share.toFixed(1)+'%' : '–',
    sub: srcTag==='BINANCE' ? 'n.v. (ohne MC)' : 'Anteil an Top‑N',
    state: share!=null? (share>=25?'yellow':(share<=12?'green':null)) : null
  });
  // 5) Breadth 7d
  const has7 = exStable.filter(c=> typeof c.ch7==='number').length;
  const green7 = exStable.filter(c=> typeof c.ch7==='number' && c.ch7>0).length;
  const breadth = has7>0 ? (green7/has7)*100 : null;
  setPulseTile('pulse-breadth', {
    val: breadth!=null? breadth.toFixed(0)+'%' : '–',
    sub: has7>0? `${green7}/${has7} im Plus` : 'n.v.',
    state: breadth!=null? (breadth>=60?'green':(breadth<40?'red':'yellow')) : null
  });
  // Status
  const st = document.getElementById('pulseStatus');
  if(st) st.textContent = 'Quelle: '+ (srcTag||'–');
}
async function refreshPulseExtras(){
  // 4) Funding
  const f = await fetchFunding();
  const fTxt = (v)=> v==null? '–' : (v>=0?'+':'')+v.toFixed(3)+'%';
  const next = f.next ? new Date(f.next) : null;
  const sub = next ? ('nächste: '+ new Date(next).toLocaleTimeString('de-AT',{hour:'2-digit',minute:'2-digit'})) : '';
  const stateB = f.btc!=null? (f.btc>0.05?'red':(f.btc<-0.01?'green':null)) : null;
  const stateE = f.eth!=null? (f.eth>0.05?'red':(f.eth<-0.01?'green':null)) : null;
  setPulseTile('pulse-funding', { val: `BTC ${fTxt(f.btc)} · ETH ${fTxt(f.eth)}`, sub, state: stateB||stateE });
  // 6) Mempool fees
  const fees = await fetchFees();
  const sub2 = fees.hour!=null? `~1h: ${fees.hour} sat/vB` : '';
  const st2 = fees.fast!=null? (fees.fast>60?'red':(fees.fast<15?'green':null)) : null;
  setPulseTile('pulse-mempool', { val: fees.fast!=null? `${fees.fast} sat/vB`:'–', sub: sub2, state: st2 });
}


async function fetchWithTimeout(url,opts={}){
  const t=opts.timeoutMs||9000; const retries=(opts.retries==null)?1:opts.retries;
  for(let a=0;a<=retries;a++){
    const ctrl=new AbortController(); const id=setTimeout(()=>ctrl.abort(),t);
    try{
      const res=await fetch(url,{...opts,signal:ctrl.signal}); clearTimeout(id);
      if(!res.ok) throw new Error('HTTP '+res.status);
      return res;
    }catch(e){ clearTimeout(id); if(a===retries) throw e; await new Promise(r=>setTimeout(r,400*(a+1))); }


// --- Fallback helpers: FX + CoinLore + Binance ---
async function fxUSDto(ccy){
  ccy = (ccy||'EUR').toUpperCase();
  if(ccy === 'USD') return 1;
  try{
    const r = await fetchWithTimeout(`https://api.exchangerate.host/convert?from=USD&to=${encodeURIComponent(ccy)}`, {timeoutMs:8000});
    const j = await r.json();
    const res = (j && typeof j.result === 'number') ? j.result : 1;
    return res || 1;
  }catch(_){ return 1; }
}

function mapCoinLoreToList(data, n, ccy, fx){
  const arr = Array.isArray(data?.data) ? data.data : [];
  const filtered = arr.filter(it=>{
    const id = String(it.nameid||'').toLowerCase();
    return !(STABLE_IDS && typeof STABLE_IDS.has==='function' && STABLE_IDS.has(id));
  }).slice(0, n);

  const sumMc = filtered.reduce((a,c)=> a + (((+c.market_cap_usd)||0)*fx), 0) || 1;

  return filtered.map(c=>({
    id: String(c.nameid||c.symbol||'').toLowerCase(),
    name: c.name,
    symbol: String(c.symbol||'').toUpperCase(),
    image: "",
    price: ((+c.price_usd)||0)*fx,
    ch24:  (+c.percent_change_24h)||0,
    ch7:   (c.percent_change_7d==null)?null:(+c.percent_change_7d||0),
    mc:    ((+c.market_cap_usd)||0)*fx,
    vol24: ((+c.volume24)||0)*fx,
    dominance: (((+c.market_cap_usd||0)*fx)/sumMc)*100,
    spark7: [],
    athDraw: null
  }));
}

async function loadFromCoinLore(n, ccy){
  const url = `https://api.coinlore.net/api/tickers/?start=0&limit=${Math.min(250, n+20)}`;
  const r = await fetchWithTimeout(url, {timeoutMs:9000});
  if(!r.ok) throw new Error('CoinLore HTTP '+r.status);
  const j = await r.json();
  const fx = await fxUSDto(ccy);
  return mapCoinLoreToList(j, n, ccy, fx);
}

// Binance 24h ticker (USDT pairs) as last-resort price fallback
async function loadFromBinance(n, ccy){
  const r = await fetchWithTimeout('https://api.binance.com/api/v3/ticker/24hr', {timeoutMs:9000});
  if(!r.ok) throw new Error('Binance HTTP '+r.status);
  const arr = await r.json();
  // USDT pairs only, exclude leveraged & stablecoin bases
  const STABLE_BASES = new Set(['USDT','USDC','FDUSD','TUSD','DAI','USDP','USDD','PYUSD','GUSD','EURS','EURT']);
  const badSuffix = ['UPUSDT','DOWNUSDT','BULLUSDT','BEARUSDT'];
  const isBad = (sym)=> badSuffix.some(sfx=> sym.endsWith(sfx));
  const rows = (Array.isArray(arr)?arr:[])
   .filter(o=> typeof o.symbol==='string' && o.symbol.endsWith('USDT') && !isBad(o.symbol))
   .map(o=>{
      const sym = o.symbol.replace('USDT','');
      if(STABLE_BASES.has(sym)) return null;
      return {
        base: sym,
        last: +o.lastPrice || 0,
        ch24: +o.priceChangePercent || 0,
        qvol: +o.quoteVolume || 0
      };
   }).filter(Boolean)
   .sort((a,b)=> b.qvol - a.qvol)
   .slice(0, n);

  const fx = await fxUSDto(ccy);
  const list = rows.map(r=>({
    id: r.base.toLowerCase(),
    name: r.base,
    symbol: r.base,
    image: "",
    price: r.last * fx,          // USDT≈USD → FX to ccy
    ch24:  r.ch24,
    ch7:   null,
    mc:    null,
    vol24: r.qvol * fx,          // quote vol in USDT
    dominance: null,
    spark7: [],
    athDraw: null
  }));
  return list;
}

  }
}

async function loadTrending(){
  try{ const r=await fetchWithTimeout('https://api.coingecko.com/api/v3/search/trending',{timeoutMs:8000}); const j=await r.json(); trendingIds=new Set((j.coins||[]).map(x=>x.item&&x.item.id).filter(Boolean)); }catch(e){}
}

async function loadTopCoins(){const get = (sel)=>{ try { return q ? q(sel) : document.querySelector(sel); } catch(_) { return null; } };
  const setText = (sel,txt)=>{ const el=get(sel); if(el) el.textContent=txt; };
  const setHTML = (sel,html)=>{ const el=get(sel); if(el) el.innerHTML=html; };

  const cur = (typeof CURRENCY==='string' && CURRENCY) ? CURRENCY : 'EUR';
  const vs  = cur.toLowerCase();
  const n   = (typeof COUNT==='number' && COUNT>0) ? COUNT : 20;
  const per = Math.min(250, n+20);

  setText('#globalStatus', `Lade Top-${n} (${cur})…`);

  const url =
    `https://api.coingecko.com/api/v3/coins/markets`+
    `?vs_currency=${encodeURIComponent(vs)}`+
    `&order=market_cap_desc&per_page=${per}&page=1`+
    `&sparkline=true&price_change_percentage=24h,7d`;

  const doFetch = (typeof fetchWithTimeout==='function')
    ? (u)=>fetchWithTimeout(u,{timeoutMs:9000})
    : (u)=>fetch(u,{cache:'no-store'});

  // --- 1) CoinGecko primary
  (async ()=>{
    try{
      const r = await doFetch(url);
      if(!r.ok) throw new Error(`HTTP ${r.status}`);
      const data = await r.json();
      const arr = Array.isArray(data) ? data : [];

      const isStable = (id)=> !!(STABLE_IDS && typeof STABLE_IDS.has==='function' && STABLE_IDS.has(id));
      const filtered = arr.filter(c=>!isStable(c.id)).slice(0, n);
      const sumMc = filtered.reduce((a,c)=> a + (+c.market_cap||0), 0) || 1;

      const list = filtered.map(c=>({
        id:c.id, name:c.name, symbol:String(c.symbol||'').toUpperCase(), image:c.image||'',
        price:+c.current_price||0, ch24:+(c.price_change_percentage_24h||0), ch7:+(c.price_change_percentage_7d_in_currency||0),
        mc:+c.market_cap||0, vol24:+c.total_volume||0, dominance: ((+c.market_cap||0)/sumMc)*100,
        spark7:(c.sparkline_in_7d && Array.isArray(c.sparkline_in_7d.price))?c.sparkline_in_7d.price:[],
        athDraw:(typeof c.ath_change_percentage==='number')?Math.abs(c.ath_change_percentage):null
      }));

      lastCoins = list;
      renderTopCoins(list);
      const tz = TZ || Intl.DateTimeFormat().resolvedOptions().timeZone;
      const now = nowV();
      setText('#ts-top', `Stand: ${now.toLocaleString('de-AT',{timeZone:tz,hour12:false})}`);
      setText('#topNLabel', `Top-${n} Coins`);
      setHTML('#topNote', `<span class="ok">Quelle:</span> CoinGecko · Stablecoins ausgeschlossen · Währung: <b>${cur}</b>`);
      setText('#globalStatus', 'Fertig');
      try{ updateCryptoPulse('COINGECKO'); refreshPulseExtras(); }catch(_){/*noop*/}

    }catch(e1){
      console.warn('CoinGecko fehlgeschlagen – Fallback CoinLore', e1);

      // --- 2) CoinLore fallback
      (async ()=>{
        try{
          const list = await loadFromCoinLore(n, cur);
          lastCoins = list;
          renderTopCoins(list);
          const tz = TZ || Intl.DateTimeFormat().resolvedOptions().timeZone;
          const now = nowV();
          setText('#ts-top', `Stand: ${now.toLocaleString('de-AT',{timeZone:tz,hour12:false})}`);
          setText('#topNLabel', `Top-${n} Coins`);
          setHTML('#topNote', `<span class="ok">Quelle:</span> CoinLore + exchangerate.host (FX) · Stablecoins ausgeschlossen · Währung: <b>${cur}</b>`);
          setText('#globalStatus', 'Fertig (Fallback 2 aktiv)');
        try{ updateCryptoPulse('COINLORE'); refreshPulseExtras(); }catch(_){}

        }catch(e2){
          console.warn('CoinLore fehlgeschlagen – Fallback Binance', e2);

          // --- 3) Binance fallback (price only)
          try{
            const list = await loadFromBinance(n, cur);
            lastCoins = list;
            renderTopCoins(list);
            const tz = TZ || Intl.DateTimeFormat().resolvedOptions().timeZone;
            const now = nowV();
            setText('#ts-top', `Stand: ${now.toLocaleString('de-AT',{timeZone:tz,hour12:false})}`);
            setText('#topNLabel', `Top-${n} Coins`);
            setHTML('#topNote', `<span class="warn">Quelle:</span> Binance 24h Ticker (nur Preis/%24h, ohne MC/Sparkline) + FX · Währung: <b>${cur}</b>`);
            setText('#globalStatus', 'Fertig (Fallback 3 aktiv)');
            try{ updateCryptoPulse('BINANCE'); refreshPulseExtras(); }catch(_){/*noop*/}

          }catch(e3){
            console.error('Alle Quellen fehlgeschlagen:', e3);
            setText('#globalStatus','Fehler beim Laden (alle Quellen).');
          }
        }
      })();
    }
  })();
}



async function loadFGI(){
  try{
    const r=await fetchWithTimeout('https://api.alternative.me/fng/?limit=1',{timeoutMs:8000}); const j=await r.json(); const d=(j&&j.data&&j.data[0])?j.data[0]:null;
    if(d){ q('#fgiGauge').textContent='FGI: '+d.value+' – '+d.value_classification; q('#ts-fgi').textContent='Stand: '+ nowV().toLocaleString('de-AT',{timeZone:TZ,hour12:false}); q('#fgiImgWrap').style.display='none'; }
    else throw new Error('leer');
  }catch(e){ q('#fgiGauge').textContent='FGI Fallback-Bild'; q('#fgiImgWrap').style.display='block'; q('#ts-fgi').textContent='Stand: '+ nowV().toLocaleString('de-AT',{timeZone:TZ,hour12:false}); }
}

// ========= Rendering =========
function drawSpark(canvas, arr){
  const ctx=canvas.getContext('2d'); const dpr=window.devicePixelRatio||1;
  const w=canvas.width=canvas.clientWidth*dpr; const h=canvas.height=canvas.clientHeight*dpr;
  ctx.clearRect(0,0,w,h);
  if(!arr||arr.length<2){ ctx.fillStyle='#99a'; ctx.fillText('–',6,h-6); return; }
  const min=Math.min(...arr), max=Math.max(...arr), pad=4*dpr, range=(max-min)||1;
  ctx.lineWidth=2*dpr; const up=arr[arr.length-1]>=arr[0]; ctx.strokeStyle=up?'#22c55e':'#ef4444';
  ctx.beginPath();
  arr.forEach((v,i)=>{ const x=pad+(w-2*pad)*(i/(arr.length-1)); const y=h-pad-((v-min)/range)*(h-2*pad); if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y); });
  ctx.stroke();
  const lx=pad+(w-2*pad), ly=h-pad-((arr[arr.length-1]-min)/range)*(h-2*pad); ctx.beginPath(); ctx.arc(lx,ly,3*dpr,0,Math.PI*2); ctx.fillStyle=ctx.strokeStyle; ctx.fill();
}

function buzzSourceFor(c){
  if(!SHOW_BUZZ) return null;
  if(trendingIds.has(c.id)) return 'CoinGecko Trending';
  if(c.vol24 && c.mc && (c.vol24/c.mc)>0.25) return 'Volumen‑Spike (>25% MC)';
  return null;
}
function htmlDYOR(c,src){
  if(!SHOW_DYOR) return '';
  const qstr=encodeURIComponent((c.name||'')+' '+(c.symbol||''));
  return `<div class="small muted">DYOR: <a href="https://www.coingecko.com/en/coins/${c.id}" target="_blank" rel="noopener">CoinGecko</a> · <a href="https://www.reddit.com/search/?q=${qstr}" target="_blank" rel="noopener">Reddit</a> · <a href="https://x.com/search?q=${qstr}" target="_blank" rel="noopener">X</a> · <a href="https://news.google.com/search?q=${qstr}" target="_blank" rel="noopener">News</a> <span class="muted">Quelle: ${src||'–'}</span></div>`;
}

function renderTopCoins(list){
  const grid=q('#coinGrid'); grid.innerHTML='';
  if(!list||!list.length){ grid.innerHTML='<div class="hint error">Keine Daten.</div>'; return; }
  for(let i=0;i<list.length;i++){
    const c=list[i]; const compact=(COUNT>10 && i>=10);
    const mom=momentumScore(c);
    const buzz=buzzSourceFor(c);
    const el=document.createElement('article'); el.className='coin'+(compact?' compact':'');
    const header=`<header>
  <img src="${c.image||''}" alt="" style="width:22px;height:22px;border-radius:50%;border:1px solid var(--border)" onerror="this.style.display='none'">
  <div class="meta"><div class="sym">${c.symbol}</div><div class="name muted small">${c.name}</div></div>
  <div class="price-inline ${pc(c.ch24)}">${fmtCur(c.price)}</div></header>`;
  
  
  
  
  
  
    if(compact){
      el.innerHTML=header
        + `<div class=\"row price\"><div class=\"muted small\">Preis</div><div>${fmtCur(c.price)}</div></div>`
        + `<div class=\"row ch24\"><div class=\"muted small\">24h</div><div class=\"${pc(c.ch24)}\">${fmtPct(c.ch24)}</div></div>`
        + `<canvas class=\"spark compact\" aria-label=\"Sparkline ${c.symbol} (${RANGE}d)\"></canvas>`;
    el.addEventListener('click', (ev)=>{ if(ev.target.closest('a,button')) return; if(window.matchMedia('(max-width: 640px)').matches){ openCardOverlay(el); } }); 
    }else{
      el.innerHTML=header
        + `<div class="row price"><div class="muted small">Preis</div><div>${fmtCur(c.price)}</div></div>`
        + `<div class="row ch24"><div class="muted small">24h</div><div class="${pc(c.ch24)}">${fmtPct(c.ch24)}</div></div>`
        + `<div class="row ch7"><div class="muted small">7d</div><div class="${pc(c.ch7)}">${fmtPct(c.ch7)}</div></div>`
        + `<div class="row"><div class="muted small">MCap</div><div>${c.mc?fmtCurC(c.mc):'–'}</div></div>`
        + `<div class="row"><div class="muted small">Vol 24h</div><div>${c.vol24?fmtCurC(c.vol24):'–'}</div></div>`
        + `<div class="row"><div class="muted small">Dominanz</div><div>${fmtPct(c.dominance)}</div></div>`
        + `<div class="row"><div class="muted small">ATH‑DD</div><div>${(typeof c.athDraw==='number')?fmtPct(c.athDraw):'–'}</div></div>`
        + htmlDYOR(c,buzz)
        + `<canvas class="spark" aria-label="Sparkline ${c.symbol} (${RANGE}d)"></canvas>`;
    }
    grid.appendChild(el);
    const canvas=q('canvas.spark',el);
    if(RANGE===7 && c.spark7){ drawSpark(canvas,c.spark7); }
    else { const ctx=canvas.getContext('2d'); ctx.fillText('–',6,16); }
  }
  buildScenario(list);
}



function openCardOverlay(cardEl){
  const ov = q('#cardOverlay'), cont = q('#overlayContent');
  if(!ov || !cont) return;
  // Clone the card to show full details
  const clone = cardEl.cloneNode(true);
  // Ensure all rows visible in overlay
  clone.querySelectorAll('.row').forEach(r=> r.style.display='');
  clone.querySelectorAll('.spark').forEach(s=> s.style.display='');
  cont.innerHTML = '';
  cont.appendChild(clone);
  ov.classList.add('open'); ov.setAttribute('aria-hidden','false');
}
function closeCardOverlay(){
  const ov = q('#cardOverlay'); if(!ov) return;
  ov.classList.remove('open'); ov.setAttribute('aria-hidden','true');
  const cont = q('#overlayContent'); if(cont) cont.innerHTML='';
}
document.addEventListener('click', (e)=>{
  if(e.target && e.target.id==='overlayClose') { closeCardOverlay(); }
  // clicking outside card closes
  const ov = q('#cardOverlay');
  if(ov && ov.classList.contains('open')){
    const cardBox = q('.overlay-card', ov);
    if(cardBox && !cardBox.contains(e.target) && ov.contains(e.target)) closeCardOverlay();
  }
});



// ========= Szenario =========
function momentumScore(c){
  let s=0.5;
  if(typeof c.ch24==='number') s+=Math.tanh(c.ch24/10)*0.2;
  if(typeof c.ch7==='number') s+=Math.tanh(c.ch7/20)*0.2;
  if(c.spark7 && c.spark7.length>1){ const slope=(c.spark7[c.spark7.length-1]-c.spark7[0])/(c.spark7[0]||1); s+=Math.tanh(slope*2)*0.2; }
  return Math.max(0,Math.min(1,s));
}
function probsFromMomentum(m){ const x=(m*2)-1, s=0.55, d=2*s*s;
  const sb=Math.exp(-((x+1)*(x+1))/d), sm=Math.exp(-(x*x)/d), su=Math.exp(-((x-1)*(x-1))/d);
  let bear=Math.round((sb/(sb+sm+su))*100), base=Math.round((sm/(sb+sm+su))*100), bull=100-bear-base; return {bear,base,bull}; }
function computeScenario(m){ return probsFromMomentum(m); }
function makeReason(c,m){ const arr=[]; if(typeof c.ch24==='number') arr.push('24h '+(c.ch24>=0?'+':'')+c.ch24.toFixed(2)+'%'); if(typeof c.ch7==='number') arr.push('7d '+(c.ch7>=0?'+':'')+c.ch7.toFixed(2)+'%'); if(c.vol24) arr.push('Vol '+fmtCurC(c.vol24)); arr.push(m>0.5?'Momentum ↑':'Momentum ↓/seitw.'); return arr.join(' · '); }

function bgStyle(kind, val, bear, base, bull){
  const clamp=(n,min,max)=>Math.min(max,Math.max(min,n));
  const ease=p=>Math.pow(clamp(p,0,1),0.7);
  const aMap=(lo,hi,p)=>(lo+(hi-lo)*ease(p/100)).toFixed(3);
  const v=clamp(val||0,0,100);
  if(kind==='bear') return `background: rgba(239,68,68,${aMap(0.06,0.22,v)});`;
  if(kind==='bull') return `background: rgba(34,197,94,${aMap(0.06,0.22,v)});`;
  if(kind==='base'){ const baseA=aMap(0.04,0.10,v); const tilt=clamp(Math.abs((bull||0)-(bear||0)),0,100);
    const tiltA=aMap(0.00,0.16,tilt); const rgb=((bull||0)>=(bear||0))?'34,197,94':'239,68,68';
    return `background: linear-gradient(180deg, rgba(245,158,11,${baseA}), rgba(245,158,11,${baseA})), linear-gradient(180deg, rgba(${rgb},${tiltA}), rgba(${rgb},${tiltA}));`; }
  return '';
}

function buildScenario(list){
  const tb=q('#scenTable tbody'); tb.innerHTML='';
  const enriched=list.map(c=>{ const m=momentumScore(c); const sc=computeScenario(m); const score=(sc.bull-sc.bear)+(m-0.5)*20 + (trendingIds.has(c.id)?15:0) + ((c.vol24&&c.mc&&(c.vol24/c.mc)>0.25)?8:0); return {c,m,sc,score}; });
  enriched.sort((a,b)=>b.score-a.score || b.sc.bull-a.sc.bull || (b.c.mc||0)-(a.c.mc||0));
  enriched.forEach(({c,m,sc})=>{
    const bear=sc.bear, base=sc.base, bull=sc.bull;
    const maxTag = (bull>=base && bull>=bear) ? 'bull' : (base>=bear ? 'base' : 'bear');
    const tr=document.createElement('tr');
    const buzz= buzzSourceFor(c);
    tr.innerHTML=`<td><strong>${c.symbol}</strong>${buzz?' <span title="'+buzz+'">🔥</span>':''}</td>
      <td class="col-bull${maxTag==='bull'?' emph':''}" style="${bgStyle('bull',bull,bear,base,bull)}">${bull}%</td>
      <td class="col-base${maxTag==='base'?' emph':''}" style="${bgStyle('base',base,bear,base,bull)}">${base}%</td>
      <td class="col-bear${maxTag==='bear'?' emph':''}" style="${bgStyle('bear',bear,bear,base,bull)}">${bear}%</td>
      <td class="small col-reason">${makeReason(c,m)}</td>`;
    tb.appendChild(tr);
  });
  q('#ts-scen').textContent='Stand: '+ nowV().toLocaleString('de-AT',{timeZone:TZ,hour12:false});
}


// ========= Exchanges =========
function renderExchanges(){
  const wrap=q('#exchList'); wrap.innerHTML='';
  const list=[{id:'binance',name:'Binance',url:'https://www.binance.com/'},{id:'coinbase',name:'Coinbase',url:'https://www.coinbase.com/'},{id:'kraken',name:'Kraken',url:'https://www.kraken.com/'},{id:'bitget',name:'Bitget',url:'https://www.bitget.com/'}];
  list.forEach(x=>{ const ref=localStorage.getItem('ref_'+x.id)||''; const href=ref||x.url; const card=document.createElement('div'); card.className='section'; card.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center">
      <div><strong>${x.name}</strong><div class="small"><a href="${href}" target="_blank" rel="noopener">Account eröffnen</a></div></div>
      <span class="badge">${ref?'Ref‑Link aktiv':'Offizieller Link'}</span></div>`; wrap.appendChild(card); });
}

// ========= Settings =========
function populateSettings(){
  qa('input[name="ccy"]').forEach(r=>r.checked=(r.value.toUpperCase()===CURRENCY));
  qa('input[name="count"]').forEach(r=>r.checked=(parseInt(r.value,10)===COUNT));
  qa('input[name="range"]').forEach(r=>r.checked=(parseInt(r.value,10)===RANGE));
  qa('input[name="theme"]').forEach(r=>r.checked=(r.value===THEME));
  q('#trendBgToggle').checked=TREND_BG; q('#dyorToggle').checked=SHOW_DYOR; q('#buzzToggle').checked=SHOW_BUZZ; q('#showExchToggle').checked=SHOW_EXCH;
  q('#autoReloadToggleSettings').checked=AUTO_RELOAD; qa('input[name="ar"]').forEach(r=>r.checked=(parseInt(r.value,10)===AUTO_MIN));
}
function openSettings(){ populateSettings(); const m=q('#settingsModal'); m.setAttribute('open',''); m.removeAttribute('aria-hidden'); }
function closeSettings(){ const m=q('#settingsModal'); m.removeAttribute('open'); m.setAttribute('aria-hidden','true'); }
function onSettingsSubmit(e){
  e.preventDefault();
  const ccy=q('input[name="ccy"]:checked'); CURRENCY=(ccy?ccy.value:'EUR').toUpperCase(); localStorage.setItem('ccy',CURRENCY);
  const cnt=q('input[name="count"]:checked'); COUNT=parseInt(cnt?cnt.value:'5',10); localStorage.setItem('count',String(COUNT));
  const rng=q('input[name="range"]:checked'); RANGE=parseInt(rng?rng.value:'7',10); localStorage.setItem('range',String(RANGE));
  const th=q('input[name="theme"]:checked'); THEME=th?th.value:'dark'; localStorage.setItem('theme',THEME);
  TREND_BG=!!q('#trendBgToggle').checked; localStorage.setItem('trendBg',TREND_BG?'on':'off');
  SHOW_DYOR=!!q('#dyorToggle').checked; localStorage.setItem('showDyor',SHOW_DYOR?'on':'off');
  SHOW_BUZZ=!!q('#buzzToggle').checked; localStorage.setItem('showBuzz',SHOW_BUZZ?'on':'off');
  SHOW_EXCH=!!q('#showExchToggle').checked; localStorage.setItem('showExch',SHOW_EXCH?'on':'off');
  const auto=q('#autoReloadToggleSettings'); setAutoReload(!!auto.checked);
  const iv=q('input[name="ar"]:checked'); AUTO_MIN=parseInt(iv?iv.value:'15',10)||15; localStorage.setItem('autoMin',String(AUTO_MIN)); updateAutoLabel();
  closeSettings(); applyTheme(); applyTrendBg(); applyShowExch(); layoutPad(); boot();
}

// ========= Boot =========
async function boot(){
  applyTheme(); applyTrendBg(); applyShowExch(); layoutPad(); updateAutoLabel();
  q('#hdrCount').textContent=String(COUNT);
  q('#meta-time').textContent='Stand: '+ nowV().toLocaleString('de-AT',{timeZone:TZ,hour12:false})+' · '+CURRENCY;
  q('#autoReloadToggle').checked=AUTO_RELOAD;
  setAutoReload(AUTO_RELOAD); if(!countdownTimer){ countdownTimer=setInterval(updateCountdown,1000); }
  renderExchanges();
  await Promise.allSettled([loadTrending(), loadFGI()]);
  await loadTopCoins();
  
}

// ========= Events =========
window.addEventListener('resize', layoutPad);
document.addEventListener('DOMContentLoaded', layoutPad);
applyGeoLangUI();
const geoBtn=q('#geoReloadBtn'); if(geoBtn){ geoBtn.addEventListener('click', ()=>updateGeoTopics(true)); }

q('#refreshBtn').addEventListener('click', ()=>{ if(AUTO_RELOAD){ nextReloadAt=Date.now()+AUTO_MIN*60*1000; } boot(); });
q('#openSettingsBtn').addEventListener('click', openSettings);
q('#closeSettingsBtn').addEventListener('click', closeSettings);
q('#cancelSettingsBtn').addEventListener('click', closeSettings);
q('#settingsModal').addEventListener('click', (e)=>{ if(e.target.id==='settingsModal') closeSettings(); });
q('#settingsForm').addEventListener('submit', onSettingsSubmit);



q('#autoReloadToggle').addEventListener('change', (e)=> setAutoReload(!!e.target.checked));


// Observe header size changes (e.g., when toolbar wraps)
try{
  const _topbar = q('.topbar');
  if(window.ResizeObserver && _topbar){
    const ro = new ResizeObserver(()=> layoutPad());
    ro.observe(_topbar);
  }
}catch(_e){}
window.addEventListener('orientationchange', layoutPad);
window.addEventListener('pageshow', layoutPad);

q('#newsHighOnly') && q('#newsHighOnly').addEventListener('change', ()=>{
  try{
    const j=JSON.parse(localStorage.getItem('newsCache')||'{}'); renderNews(j.items||[], false);
  }catch(_){ loadNews(); }
});

// Start
boot();
</script>

<div id="cardOverlay" class="overlay" aria-hidden="true">
  <div class="overlay-card">
    <button class="btn close" id="overlayClose" aria-label="Schließen">×</button>
    <div id="overlayContent"></div>
  </div>
</div>
<script>
// --- robuster Loader für KI-Themen (zeigt Fehler textlich an) ---
async function geoFetchJSON(url, opt){ 
  const r = await fetch(url, opt);
  // auch Fehlerseiten als Text lesen und sinnvoll behandeln
  const txt = await r.text();
  try { return { ok:r.ok, status:r.status, json: JSON.parse(txt) }; }
  catch { return { ok:r.ok, status:r.status, text: txt }; }
}

function geoRender(items, bullets){
  const list = document.querySelector('#geoTopicsList');
  const status = document.querySelector('#geoFeedStatus');
  const errBox = document.querySelector('#geoError');
  list.innerHTML = '';
  errBox.style.display = 'none'; errBox.textContent = '';
  const n = Math.min(4, items.length, bullets.length);
  for(let i=0;i<n;i++){
    const it = items[i]; const b = (bullets[i]||'').replace(/^[-•\s]+/, '').trim();
    const li = document.createElement('li');
    const a = document.createElement('a'); a.href = it.url; a.target = '_blank'; a.rel = 'noopener';
    const domain = it.domain || new URL(it.url).hostname.replace(/^www\./,'');
    a.textContent = `${domain} – ${(it.title||'').slice(0,120)}`;
    li.textContent = `. Thema #${i+1} ${b} (`; li.appendChild(a); li.appendChild(document.createTextNode(')'));
    list.appendChild(li);
  }
  status.textContent = n ? 'aktualisiert' : 'n.v.';
}

async function loadGeoCompact(force=false){
  const status = document.querySelector('#geoFeedStatus');
  const errBox = document.querySelector('#geoError');
  status.textContent = 'lädt…'; errBox.style.display = 'none'; errBox.textContent = '';

  // 1) Quellen holen
  const feed = await geoFetchJSON('/api/geo_feed');
  if(!feed.ok){
    errBox.style.display = 'block';
    errBox.textContent = `Geo-Feed Fehler ${feed.status}: ` + (feed.json?.error ? JSON.stringify(feed.json.error) : (feed.text||'keine Details'));
    status.textContent = 'Fehler';
    return;
  }
  const items = Array.isArray(feed.json.items) ? feed.json.items.slice(0,8) : [];

  // 2) Bullets holen (POST)
  let bullets = [];
  if(items.length){
    const titles = items.map(it=> it.title || it.domain || 'Quelle');
    const res = await geoFetchJSON('/api/summary', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ titles })
    });
    if(!res.ok){
      // lesbar anzeigen (Gateway/Key/Model-Fehler etc.)
      errBox.style.display = 'block';
      errBox.textContent = `Summary Fehler ${res.status}: ` + (res.json?.error ? JSON.stringify(res.json.error) : (res.text||'keine Details'));
      // Fallback: sehr kurze Titel verwenden, damit trotzdem etwas erscheint
      bullets = titles.map(t => t.length>90 ? t.slice(0,87)+'…' : t);
    }else{
      bullets = Array.isArray(res.json.bullets) ? res.json.bullets.slice(0, items.length) : [];
    }
  }

  // 3) Rendern / Fallback
  if(!bullets.length && items.length){
    bullets = items.map(it => (it.title||'').trim()).map(t=> t.length>90? t.slice(0,87)+'…':t);
  }
  geoRender(items, bullets);
}

// Button & Timer
document.addEventListener('DOMContentLoaded', ()=>{
  const btn = document.querySelector('#geoReloadBtn');
  if(btn) btn.addEventListener('click', ()=> loadGeoCompact(true));
  loadGeoCompact(true);
  setInterval(()=>loadGeoCompact(true), 4*60*60*1000);
});
</script>


<script>
// Banner
async function loadMarketsBanner(){
  try{
    const tryOne = async (u)=>fetch(u,{cache:'no-store'}).then(r=>r.ok?r.text():null).catch(()=>null);
    const html = await tryOne('/banner') || await tryOne('/banner.html');
    if(html){ const box=document.getElementById('marketsBanner'); if(box) box.innerHTML=html; }
  }catch(_){}
}
document.addEventListener('DOMContentLoaded', loadMarketsBanner);
</script>
<script>
/* --- Geo/Makro (kompakt) – robuste Einzellogik --- */
(function(){
  const $ = (s,r=document)=>r.querySelector(s);
  const txt = (el, t)=>{ if(el) el.textContent = t; };

  async function fetchJson(url, init){
    const res = await fetch(url, init);
    const raw = await res.text();
    try { return { ok: res.ok, status: res.status, json: JSON.parse(raw) }; }
    catch { return { ok: res.ok, status: res.status, text: raw }; }
  }

  function render(items, bullets){
    const list = $('#geoTopicsList'); if(!list) return;
    list.innerHTML = '';
    const n = Math.min(4, items.length);
    for(let i=0;i<n;i++){
      const it = items[i];
      const b = (bullets?.[i] || '').replace(/^[-•\s]+/,'').trim();
      const li = document.createElement('li');

      const a = document.createElement('a');
      a.href = it.url; a.target = '_blank'; a.rel = 'noopener';
      const domain = it.domain || new URL(it.url).hostname.replace(/^www\./,'');
      a.textContent = `${domain} – ${(it.title||'').slice(0,120)}`;

      li.appendChild(document.createTextNode(`• ${b || (it.title||'').slice(0,80)} (`));
      li.appendChild(a);
      li.appendChild(document.createTextNode(')'));
      list.appendChild(li);
    }
  }

  async function loadGeo(force=false){
    const st  = $('#geoFeedStatus');
    const err = $('#geoError');
    const sel = $('#geoLang');

    txt(st, 'lädt…');
    if(err){ err.style.display = 'none'; err.textContent = ''; }

    const lang = (sel?.value || 'EN').toUpperCase();

    // 1) Quellen holen
    const feed = await fetchJson('/api/geo_feed?lang=' + encodeURIComponent(lang));
    if(!feed.ok || !Array.isArray(feed.json?.items)){
      if(err){
        err.style.display = 'block';
        err.textContent = `Geo-Feed Fehler ${feed.status||''}: ` +
                          (feed.json?.error?.message || feed.text || 'keine Details');
      }
      txt(st,'Fehler');
      return;
    }
    const items = feed.json.items.slice(0,8);

    // 2) Kurz-Bullets generieren (KI), super knapp
    const prompt = `Return exactly 4 ultra-short bullets in ${lang==='DE'?'German':'English'} about geopolitics/macro **relevant to crypto**. `
                 + `Max 18 words per bullet, no intro/outro, no numbering.`;

    const sum = await fetchJson('/api/summary', {
      method: 'POST',
      headers: { 'Content-Type':'application/json' },
      body: JSON.stringify({
        provider: 'openai',
        system: 'Be terse. Focus only on crypto-relevant geopolitics/macro facts.',
        prompt,
        items
      })
    });

    if(!sum.ok || !Array.isArray(sum.json?.bullets)){
      if(err){
        err.style.display = 'block';
        err.textContent = `Summary Fehler ${sum.status||''}: ` +
                          (sum.json?.error?.message || sum.text || ''); 
      }
      // Fallback: nur die Headlines
      render(items, []);
      txt(st, 'teilweise');
      return;
    }

    render(items, sum.json.bullets);
    txt(st, 'aktualisiert');
  }

  document.addEventListener('DOMContentLoaded', ()=>{
    $('#geoReload')?.addEventListener('click', ()=> loadGeo(true));
    $('#geoLang')?.addEventListener('change', ()=> loadGeo(true));
    loadGeo(true);
  });

</script>

</body>
</html>
