<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>OneSide — Markets & Macro</title>
<meta name="theme-color" content="#0b1220">
<link rel="icon" href="/favicon.ico" sizes="any">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32.png">
<link rel="apple-touch-icon" href="/apple-touch-icon.png">
<link rel="manifest" href="/site.webmanifest">
<style>
:root{
  --bg:#0b1220; --panel:#0f172a; --muted:#9ca3af; --fg:#e5e7eb; --accent:#7c3aed; --ok:#22c55e; --err:#f87171;
  --b:#1f2937; --br:14px; --sh:0 10px 20px rgba(0,0,0,.25);
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--fg);font:14px/1.5 Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
a{color:#93c5fd} .muted{color:var(--muted)} .small{font-size:.9rem}
.container{max-width:1120px;margin:24px auto;padding:0 16px}
h1{font-size:1.25rem;margin:0 0 10px 0;font-weight:700}
.card{background:var(--panel);border:1px solid #111827;border-radius:var(--br);box-shadow:var(--sh);padding:16px}
.row{display:flex;gap:10px;align-items:center}
.between{justify-content:space-between}
.btn{background:#111827;border:1px solid #1f2937;border-radius:10px;color:var(--fg);padding:6px 10px;cursor:pointer}
.btn:hover{background:#0b1220}
hr.thin{border:0;border-top:1px solid #1f2230;margin:10px 0}
.hidden{display:none !important}

#marketsBanner{margin:0 0 14px 0}

.section-title{font-weight:700}
ul.bullets{list-style:none;padding-left:0;margin:6px 0}
ul.bullets li{font-size:.9rem;line-height:1.35;margin:2px 0}
#geoTopicsList li{font-size:.9rem}
#geoToolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:6px 0 8px}
#geoSrcList{font-size:.85rem;color:var(--muted);margin-top:4px}
#geoError{display:none;font-size:.85rem;color:var(--err);background:#111827;padding:.5rem;border-radius:10px;white-space:pre-wrap}

.settings{position:fixed;right:18px;bottom:18px;z-index:10}
#settingsPanel{position:fixed;right:18px;bottom:60px;width:320px;background:var(--panel);border:1px solid #111827;border-radius:14px;box-shadow:var(--sh);padding:14px;display:none}
fieldset{border:1px solid #1f2230;border-radius:10px;padding:10px;margin:6px 0}
legend{padding:0 6px;color:var(--muted)}
label.inline{display:inline-flex;gap:6px;align-items:center;margin-right:10px}
</style>
</head>
<body>
<div class="container">
  <div id="marketsBanner"></div>

  <div class="card">
    <div class="row between">
      <h1>Geopolitik &amp; Makro (kompakt)</h1>
      <div class="muted small" id="geoFeedStatus">bereit</div>
    </div>

    <div id="geoToolbar">
      <button id="geoReloadBtn" class="btn small" type="button">↻ Neu laden</button>
      <label class="inline small muted">Sprache
        <select id="geoLangSel" class="btn small" style="padding:4px 8px">
          <option value="en">EN</option>
          <option value="de">DE</option>
          <option value="auto">Auto</option>
        </select>
      </label>
    </div>

    <ul id="geoTopicsList" class="bullets"></ul>
    <div id="geoSrcList" class="small muted"></div>
    <pre id="geoError"></pre>
  </div>

  <div class="settings">
    <button class="btn" id="openSettings">⚙️ Einstellungen</button>
  </div>
  <div id="settingsPanel">
    <div class="row between"><div class="section-title small">Einstellungen</div><button class="btn small" id="closeSettings">Schließen</button></div>
    <fieldset>
      <legend>Währung (für Widgets/Fx)</legend>
      <label class="inline"><input type="radio" name="ccy" value="EUR"> EUR</label>
      <label class="inline"><input type="radio" name="ccy" value="USD"> USD</label>
      <label class="inline"><input type="radio" name="ccy" value="GBP"> GBP</label>
      <label class="inline"><input type="radio" name="ccy" value="JPY"> JPY</label>
    </fieldset>
    <fieldset>
      <legend>Seitensprache (UI)</legend>
      <label class="inline"><input type="radio" name="site_lang" value="de"> Deutsch</label>
      <label class="inline"><input type="radio" name="site_lang" value="en"> Englisch</label>
      <label class="inline"><input type="radio" name="site_lang" value="auto" checked> Auto</label>
    </fieldset>
    <p class="muted small">Börsenblock: bitte <code>banner.html</code> im Projekt anlegen (optional). Der Inhalt wird automatisch oben geladen.</p>
  </div>
</div>

<script>
// tiny helpers
const $ = (s, r=document) => r.querySelector(s);
const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
const store = (k,v)=>{ try{ localStorage.setItem(k, JSON.stringify(v)); }catch(_){}};
const load  = (k,d)=>{ try{ const v = localStorage.getItem(k); return v? JSON.parse(v): d; }catch(_){ return d; }};

// ---- Settings UI ----
(function settingsInit(){
  const open=$('#openSettings'), panel=$('#settingsPanel'), close=$('#closeSettings');
  open?.addEventListener('click', ()=> panel.style.display = 'block');
  close?.addEventListener('click', ()=> panel.style.display = 'none');
  // currency
  const savedCcy = load('ccy','EUR');
  $$('input[name="ccy"]').forEach(r=>{
    if(r.value===savedCcy) r.checked = true;
    r.addEventListener('change', ()=>{ store('ccy', r.value); window.dispatchEvent(new CustomEvent('ccy:changed',{detail:r.value})); });
  });
  // site language (for future i18n UI)
  const savedLang = load('site_lang','auto');
  $$('input[name="site_lang"]').forEach(r=>{
    if(r.value===savedLang) r.checked = true;
    r.addEventListener('change', ()=>{ store('site_lang', r.value); location.reload(); });
  });
})();

// ---- Markets Banner (external file) ----
async function loadMarketsBanner(){
  const tryFetch = async (u)=>fetch(u,{cache:'no-store'}).then(r=>r.ok?r.text():null).catch(()=>null);
  const html = await tryFetch('/banner') || await tryFetch('/banner.html');
  if(!html) return;
  $('#marketsBanner').innerHTML = html;
}
document.addEventListener('DOMContentLoaded', loadMarketsBanner);

// ---- Geo/Macro compact feed ----
let GEO_LANG = load('geoLang','en'); // default English
function applyGeoLangUI(){
  const sel = $('#geoLangSel'); if(!sel) return;
  sel.value = GEO_LANG;
  sel.addEventListener('change', ()=>{ GEO_LANG = sel.value; store('geoLang', GEO_LANG); updateGeoTopics(true); });
}
function domainOf(url){ try{ return new URL(url).hostname.replace(/^www\./,''); }catch(_){ return ''; } }
function renderGeoSources(items){
  const box = $('#geoSrcList'); if(!box) return;
  const uniq = Array.from(new Set(items.map(it=> (it.domain || domainOf(it.url))))).filter(Boolean).slice(0,6);
  box.innerHTML = uniq.length ? 'Quellen: ' + uniq.map(d=> `<a href="https://${d}" target="_blank" rel="noopener">${d}</a>`).join(' · ') : '';
}
async function getJSONorText(res){
  const txt = await res.text();
  try{ return [res.ok, res.status, JSON.parse(txt)]; }catch(_){ return [res.ok, res.status, txt]; }
}
async function updateGeoTopics(force=false){
  const st = $('#geoFeedStatus'); const list = $('#geoTopicsList'); const boxErr = $('#geoError');
  st.textContent = 'lädt…'; boxErr.style.display='none'; boxErr.textContent='';

  // Cache 4h
  if(!force){
    try{
      const c = load('geoTopicsCacheCompact',null);
      if(c && (Date.now()-c.ts) < 4*60*60*1000){ list.innerHTML=c.html; $('#geoSrcList').innerHTML=c.srcs; st.textContent='aus Cache'; return; }
    }catch(_){}
  }
  // Feed
  let ok, status, data;
  try{ [ok, status, data] = await getJSONorText(await fetch('/api/geo_feed',{cache:'no-store'})); }
  catch(e){ ok=false; status=0; data=String(e); }
  if(!ok){ boxErr.style.display='block'; boxErr.textContent = `Geo-Feed Fehler ${status}: ${typeof data==='string'?data:JSON.stringify(data)}`; st.textContent='Fehler'; return; }
  const items = Array.isArray(data.items)? data.items.slice(0,8) : [];
  if(!items.length){ list.innerHTML=''; st.textContent='n.v.'; return; }

  // Summary
  let bullets=[]; 
  try{
    const [ok2, status2, data2] = await getJSONorText(await fetch('/api/summary', {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ titles: items.slice(0,4).map(i=>i.title||i.domain||'Source'), lang: GEO_LANG })
    }));
    if(!ok2){
      boxErr.style.display='block'; boxErr.textContent = `Summary Fehler ${status2}: ${typeof data2==='string'?data2:JSON.stringify(data2)}`;
      bullets = items.map(i=> (i.title||'').trim()).map(t=> t.length>90? t.slice(0,87)+'…':t);
    }else{
      bullets = Array.isArray(data2.bullets) ? data2.bullets : [];
    }
  }catch(e){
    bullets = items.map(i=> (i.title||'').trim()).map(t=> t.length>90? t.slice(0,87)+'…':t);
  }

  // Render
  list.innerHTML = '';
  const n = Math.min(4, items.length, bullets.length);
  for(let i=0;i<n;i++){
    const it = items[i]; const b = String(bullets[i]||'').replace(/^[-•\s]+/,'').trim();
    const li = document.createElement('li');
    const a  = document.createElement('a'); a.href=it.url; a.target='_blank'; a.rel='noopener';
    const d  = it.domain || domainOf(it.url);
    a.textContent = `${d} – ${(it.title||'').slice(0,120)}`;
    li.textContent = `• ${b} (`; li.appendChild(a); li.appendChild(document.createTextNode(')'));
    list.appendChild(li);
  }
  renderGeoSources(items);
  st.textContent = 'aktualisiert';

  // Cache rendered HTML + sources for instant load
  store('geoTopicsCacheCompact',{ts:Date.now(), html:list.innerHTML, srcs: $('#geoSrcList').innerHTML});
}
document.addEventListener('DOMContentLoaded', ()=>{
  applyGeoLangUI();
  $('#geoReloadBtn')?.addEventListener('click', ()=> updateGeoTopics(true));
  updateGeoTopics(true);
  setInterval(()=>updateGeoTopics(true), 4*60*60*1000);
});
</script>
</body>
</html>
